# Rhone Risk Cyber Policy Analysis Platform — Deployment Guide

## Overview

This guide deploys three services that work together:

| Service | Platform | Directory | Purpose |
|---------|----------|-----------|---------|
| **Supabase** | supabase.com (managed) | N/A | PostgreSQL database, auth, file storage |
| **Analysis API** | Railway (Docker) | `policy-analysis-api/` | FastAPI service that analyzes policy PDFs with Claude |
| **CRM** | Vercel (Next.js) | `orchids-multi-tenant-crm/` | Web app with broker, partner, and client portals |

**Dependency order:** Supabase first, then Railway, then Vercel, then wire them together.

---

## Prerequisites

Before starting, you need:

- [ ] A GitHub account with this repo pushed to it (currently at `dunnsured/rhonepolicyanalysis`)
- [ ] An Anthropic API key with access to Claude Sonnet 4 and Claude Haiku 4.5
- [ ] Accounts on [supabase.com](https://supabase.com), [railway.app](https://railway.app), and [vercel.com](https://vercel.com)
- [ ] (Optional) A custom domain for the CRM (e.g., `app.rhonerisk.com`)

Generate your shared webhook secret now — you will use this **exact same value** in both Railway and Vercel:

```bash
openssl rand -hex 32
```

Save the output. It will look like: `a1b2c3d4e5f6...` (64 hex characters).

---

## Step 0: Push Code to GitHub

The repository has no commits yet. Create the initial commit and push:

```bash
cd /Users/rcd/PycharmProjects/rhonepolicyanalysis
git add -A
git commit -m "Initial commit: complete platform with analysis pipeline, CRM, and deployment config"
git push origin main
```

Verify the push succeeded at: `https://github.com/dunnsured/rhonepolicyanalysis`

---

## Step 1: Supabase

Everything depends on Supabase, so set this up first.

### 1A. Create Project

1. Go to [supabase.com/dashboard](https://supabase.com/dashboard)
2. Click **New Project**
3. Choose organization and name (e.g., `rhone-risk-production`)
4. Select a region close to your other services (US East recommended for Railway/Vercel)
5. Set a strong database password and **save it somewhere secure**
6. Click **Create new project** and wait for provisioning (~2 minutes)

### 1B. Collect Your Keys

Go to **Settings** → **API** and copy these three values. You will need them in Steps 2 and 3.

| Key | Where to find it | Used by |
|-----|-------------------|---------|
| **Project URL** | Settings → API → Project URL | Both Railway and Vercel |
| **anon public key** | Settings → API → Project API Keys → `anon` `public` | Vercel only |
| **service_role secret key** | Settings → API → Project API Keys → `service_role` `secret` | Both Railway and Vercel |

> **Warning:** The `service_role` key bypasses Row Level Security. Never expose it to the browser. It is only used in server-side code and environment variables.

### 1C. Run Database Migrations

Go to **SQL Editor** (left sidebar) and run these three migration files **in this exact order**:

**Migration 1 — Complete Schema:**
- Open file: `orchids-multi-tenant-crm/supabase/migrations/20260216_complete_schema.sql`
- Copy the entire contents into the SQL Editor
- Click **Run**
- Expected: creates 25+ tables (tenants, users, companies, contacts, insurance_policies, etc.)

**Migration 2 — Analysis Fields:**
- Open file: `orchids-multi-tenant-crm/supabase/migrations/20250204_add_policy_analysis_fields.sql`
- Copy the entire contents into the SQL Editor
- Click **Run**
- Expected: adds indexes and comments on analysis columns (columns already exist from Migration 1, this is safe)

**Migration 3 — RLS Policies:**
- Open file: `orchids-multi-tenant-crm/supabase/migrations/20260216_rls_policies.sql`
- Copy the entire contents into the SQL Editor
- Click **Run**
- Expected: enables RLS on all tables, creates tenant isolation policies, service role bypass, portal access policies

**Verify migrations succeeded:**
- Go to **Table Editor** — you should see all tables listed
- Click on `insurance_policies` — verify columns include `report_storage_path`, `analysis_retries`, `analysis_tokens_used`
- Go to **Authentication** → **Policies** — you should see policies on every table

### 1D. Create Storage Buckets

Go to **Storage** (left sidebar):

1. Click **New bucket**
   - Name: `insurance-policies`
   - Public: **OFF** (toggle to private)
   - Click **Create bucket**

2. Click **New bucket** again
   - Name: `reports`
   - Public: **OFF** (toggle to private)
   - Click **Create bucket**

Both buckets must be private. Files are accessed only through signed URLs generated by server-side code.

### 1E. Configure Authentication

1. Go to **Authentication** → **Providers**
2. Ensure **Email** is enabled (it is by default)
3. Go to **Authentication** → **URL Configuration**
4. Add to **Redirect URLs**:
   - `http://localhost:3000/**` (for local development)
   - `https://your-production-domain.com/**` (add after Step 3 when you know your Vercel URL)

### 1F. Seed Initial Data

You need at least one tenant and one admin user. Run this in the **SQL Editor** after you have created a Supabase Auth user (you can do this after Step 3 when you first sign up in the CRM, or create one now):

```sql
-- Create your tenant
INSERT INTO tenants (id, name, slug)
VALUES (
  gen_random_uuid(),
  'Rhône Risk Advisory',
  'rhone-risk'
);

-- After you sign up via the CRM login page, link your auth user to the tenant:
-- Replace the UUIDs below with your actual tenant ID and auth user ID
--
-- INSERT INTO users (id, auth_user_id, tenant_id, email, full_name, role)
-- VALUES (
--   gen_random_uuid(),
--   'YOUR_AUTH_USER_UUID_FROM_SUPABASE_AUTH',
--   'YOUR_TENANT_UUID_FROM_ABOVE',
--   'your@email.com',
--   'Your Name',
--   'admin'
-- );
```

> **Note:** The DB Webhook (auto-trigger for analysis) is configured in Step 4 after Vercel is deployed.

---

## Step 2: Railway (Analysis API)

### 2A. Create Project

1. Go to [railway.app](https://railway.app)
2. Click **New Project** → **Deploy from GitHub Repo**
3. Select the repo: `dunnsured/rhonepolicyanalysis`
4. Railway will detect the repo. Go to **Settings** for the service:
   - Set **Root Directory** to: `policy-analysis-api`
   - Build: Railway auto-detects the `Dockerfile` via `railway.json`

### 2B. Set Environment Variables

Go to the service's **Variables** tab and add every variable below:

```env
# REQUIRED
ANTHROPIC_API_KEY=sk-ant-api03-your-actual-key
WEBHOOK_SECRET=your-64-char-hex-secret-from-prerequisites
SUPABASE_URL=https://your-project-ref.supabase.co
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIs...your-service-role-key

# ENVIRONMENT
ENVIRONMENT=production

# CORS — set to your Vercel production URL (update after Step 3 if needed)
CORS_ORIGINS=["https://your-vercel-app.vercel.app"]

# CLAUDE MODELS
CLAUDE_MODEL=claude-sonnet-4-20250514
EXTRACTION_MODEL=claude-haiku-4-5-20251001
CLAUDE_MAX_TOKENS=16384
USE_TWO_PHASE=true

# TIMEOUTS
CALLBACK_TIMEOUT=30

# BRANDING
COMPANY_NAME=Rhône Risk Advisory
PRIMARY_COLOR=#162B4D
ACCENT_COLOR=#0CBDDB
```

### 2C. Deploy

1. Click **Deploy** (or Railway auto-deploys on push to main)
2. Wait for the build to complete (~2-4 minutes for Docker build)
3. Once deployed, Railway assigns a URL (e.g., `https://policy-analysis-api-production.up.railway.app`)

### 2D. Verify

Hit the health endpoint:

```bash
curl https://YOUR-RAILWAY-URL/health
```

Expected response:
```json
{
  "status": "healthy",
  "anthropic_configured": true,
  "supabase_configured": true,
  "environment": "production"
}
```

**Both `anthropic_configured` and `supabase_configured` must be `true`.** If either is false, check your environment variables.

Also verify the webhook test endpoint:

```bash
curl -X POST https://YOUR-RAILWAY-URL/webhook/test
```

Expected:
```json
{
  "status": "connected",
  "webhook_secret_configured": true,
  "anthropic_configured": true,
  "supabase_configured": true
}
```

**Save your Railway URL** — you need it for the next step.

---

## Step 3: Vercel (CRM)

### 3A. Create Project

1. Go to [vercel.com](https://vercel.com)
2. Click **Add New** → **Project** → **Import Git Repository**
3. Select: `dunnsured/rhonepolicyanalysis`
4. Configure:
   - **Root Directory:** `orchids-multi-tenant-crm`
   - **Framework Preset:** Next.js (should auto-detect)
   - **Build Command:** `npm run build` (default)
   - **Output Directory:** `.next` (default)

### 3B. Set Environment Variables

Add these before the first deploy:

```env
# SUPABASE
NEXT_PUBLIC_SUPABASE_URL=https://your-project-ref.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIs...your-anon-key
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIs...your-service-role-key

# APP URL — use your Vercel URL first, update to custom domain later
NEXT_PUBLIC_APP_URL=https://your-vercel-app.vercel.app
PRODUCTION_URL=https://your-vercel-app.vercel.app

# ANALYSIS API — the Railway URL from Step 2
NEXT_PUBLIC_ANALYSIS_API_URL=https://your-railway-url.up.railway.app

# WEBHOOK SECRET — must be the EXACT same value as Railway
WEBHOOK_SECRET=your-64-char-hex-secret-from-prerequisites
```

> **Critical:** `WEBHOOK_SECRET` must be identical to the value set in Railway. This is the shared secret for HMAC signature verification in both directions.

> **Critical:** `PRODUCTION_URL` must be set to your actual production URL (not a Vercel preview URL). This is what gets sent to Railway as the callback URL for analysis results. If this is wrong, analysis will complete but the CRM will never receive the results.

### 3C. Deploy

1. Click **Deploy**
2. Wait for the build (~1-2 minutes)
3. Once deployed, visit your Vercel URL — you should see the login page

### 3D. Custom Domain (Optional)

1. Go to Vercel → **Project Settings** → **Domains**
2. Add your domain (e.g., `app.rhonerisk.com`)
3. Configure DNS: add a CNAME record pointing to `cname.vercel-dns.com`
4. Wait for DNS propagation and SSL provisioning
5. **Update environment variables:**
   - `NEXT_PUBLIC_APP_URL` → `https://app.rhonerisk.com`
   - `PRODUCTION_URL` → `https://app.rhonerisk.com`
6. Redeploy for the changes to take effect

---

## Step 4: Wire Services Together

Now that all three services are running, connect them.

### 4A. Update Railway CORS

Go to Railway → your service → **Variables** → update `CORS_ORIGINS`:

```env
CORS_ORIGINS=["https://your-final-production-url.com"]
```

If using a custom domain, use that. If using the default Vercel URL, use that. This controls which origins can call the Analysis API.

### 4B. Update Supabase Auth Redirect URLs

Go to Supabase → **Authentication** → **URL Configuration** → add your final production URL:

```
https://your-final-production-url.com/**
```

### 4C. Set Up Supabase Database Webhook (Auto-Trigger)

This is the mechanism that automatically triggers policy analysis when a new policy is inserted, even if the user closes their browser.

1. Go to Supabase → **Database** → **Webhooks** (under Database in sidebar)
2. Click **Create a new webhook**
3. Configure:
   - **Name:** `auto-analyze-cyber-policies`
   - **Table:** `insurance_policies`
   - **Events:** `INSERT` only
   - **Type:** HTTP Request
   - **Method:** POST
   - **URL:** `https://YOUR-PRODUCTION-URL/api/policies/auto-analyze`
   - **Headers:** Add one header:
     - Key: `Authorization`
     - Value: `Bearer YOUR_SERVICE_ROLE_KEY`
   - **Timeout:** 5000 (5 seconds — this endpoint returns quickly, the analysis runs async)
4. Click **Create webhook**

> **Note:** The auto-analyze endpoint validates the `Authorization` header against `SUPABASE_SERVICE_ROLE_KEY`. Only Supabase can trigger it.

### 4D. Seed Your First User

1. Visit your production CRM URL
2. Click **Sign Up** with your email
3. Go to Supabase → **Authentication** → **Users** — find your new user and copy the **User UID**
4. In SQL Editor, link the user to your tenant:

```sql
-- Find your tenant ID
SELECT id, name FROM tenants;

-- Insert your CRM user (replace UUIDs with your actual values)
INSERT INTO users (id, auth_user_id, tenant_id, email, full_name, role)
VALUES (
  gen_random_uuid(),
  'PASTE-YOUR-AUTH-USER-UUID-HERE',
  'PASTE-YOUR-TENANT-UUID-HERE',
  'your@email.com',
  'Your Name',
  'admin'
);
```

5. Sign out and sign back in — you should now have full CRM access

---

## Step 5: End-to-End Verification

Run through each test to confirm the entire pipeline works.

### Test 1: Health Checks

```bash
# Analysis API
curl https://YOUR-RAILWAY-URL/health
# Expected: {"status":"healthy","anthropic_configured":true,"supabase_configured":true,...}

# CRM callback endpoint
curl https://YOUR-PRODUCTION-URL/api/webhook/analysis-complete
# Expected: {"status":"ok","endpoint":"analysis-complete-callback",...}
```

### Test 2: Manual Analysis (Happy Path)

1. Log into the CRM
2. Go to **Companies** → create a test company (e.g., "Acme Test Corp", Industry: "Technology")
3. On the company page, scroll to **Insurance Policies**
4. Click **Add Policy**:
   - Carrier: "Test Carrier"
   - Line of Coverage: **Cyber Liability** (must be this for analysis to trigger)
   - Attach a PDF file (any cyber insurance policy PDF)
   - Click **Add Policy**
5. Watch the Analysis column — it should progress through:
   - `Extracting` → `Analyzing` → `Generating Report` → `Analyzed` with a score
6. A **Report** button should appear — click it to download the branded PDF

### Test 3: Auto-Trigger (Browser Close)

1. Upload another cyber policy PDF
2. **Immediately close the browser tab**
3. Wait 2-3 minutes
4. Reopen the CRM and check the policy
5. It should show as **Analyzed** with a score — proving the DB webhook triggered analysis independently

### Test 4: Signature Verification

```bash
# Send an unsigned request to Railway — should be rejected
curl -X POST https://YOUR-RAILWAY-URL/webhook/policy-uploaded \
  -H "Content-Type: application/json" \
  -d '{"policy_id":"test","client_id":"test","client_name":"test","file_url":"https://example.com/test.pdf","file_name":"test.pdf"}'
# Expected: 401 {"detail":"Missing webhook signature"}
```

### Test 5: Check Storage

1. Go to Supabase → **Storage**
2. Open the `insurance-policies` bucket — you should see uploaded PDFs
3. Open the `reports` bucket — you should see generated analysis reports

---

## Environment Variables Reference

### Railway (Analysis API)

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `ANTHROPIC_API_KEY` | **Yes** | — | Claude API key |
| `WEBHOOK_SECRET` | **Yes** | — | Shared HMAC secret (same as Vercel) |
| `SUPABASE_URL` | **Yes** | — | Supabase project URL |
| `SUPABASE_SERVICE_KEY` | **Yes** | — | Supabase service role key |
| `ENVIRONMENT` | No | `development` | Set to `production` |
| `CORS_ORIGINS` | No | `["*"]` | JSON array of allowed origins |
| `CLAUDE_MODEL` | No | `claude-sonnet-4-20250514` | Scoring/analysis model |
| `EXTRACTION_MODEL` | No | `claude-haiku-4-5-20251001` | Fast extraction model |
| `CLAUDE_MAX_TOKENS` | No | `16384` | Max output tokens |
| `USE_TWO_PHASE` | No | `true` | Two-phase pipeline (Haiku extract + Sonnet score) |
| `CALLBACK_TIMEOUT` | No | `30` | Callback HTTP timeout in seconds |
| `COMPANY_NAME` | No | `Rhône Risk Advisory` | Branding on reports |
| `PRIMARY_COLOR` | No | `#162B4D` | Report primary color |
| `ACCENT_COLOR` | No | `#0CBDDB` | Report accent color |

### Vercel (CRM)

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `NEXT_PUBLIC_SUPABASE_URL` | **Yes** | — | Supabase project URL |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | **Yes** | — | Supabase anon/public key |
| `SUPABASE_SERVICE_ROLE_KEY` | **Yes** | — | Supabase service role key |
| `NEXT_PUBLIC_APP_URL` | **Yes** | — | Production URL of this CRM |
| `PRODUCTION_URL` | **Yes** | — | Same as above (used for callbacks) |
| `NEXT_PUBLIC_ANALYSIS_API_URL` | **Yes** | — | Railway Analysis API URL |
| `WEBHOOK_SECRET` | **Yes** | — | Shared HMAC secret (same as Railway) |

---

## Shared Secrets Map

This shows which secrets are shared between services. A mismatch in any of these will break the pipeline.

```
WEBHOOK_SECRET ──────── Must be IDENTICAL in Railway and Vercel
                        This signs/verifies webhooks in both directions:
                        CRM → Analysis API (dispatch)
                        Analysis API → CRM (callback)

SUPABASE_SERVICE_KEY ── Used by all three:
                        Railway: upload reports, persist status
                        Vercel: server-side DB queries, signed URLs
                        Supabase DB Webhook: Authorization header

SUPABASE_URL ────────── Used by Railway and Vercel
                        Points to the same Supabase project
```

---

## Troubleshooting

### Analysis dispatches but CRM never receives results

- Check `PRODUCTION_URL` in Vercel — if it is a Vercel preview URL (e.g., `my-app-abc123-dunnsured.vercel.app`), it will change on every deploy. Use a stable URL.
- Check Railway logs for callback delivery errors
- Verify `WEBHOOK_SECRET` is identical in both services

### Railway returns 401 on webhook

- The HMAC signatures do not match. Ensure `WEBHOOK_SECRET` is the exact same string in both Railway and Vercel (no trailing spaces, no quotes).

### Analysis completes but no report appears in Storage

- Check that `SUPABASE_URL` and `SUPABASE_SERVICE_KEY` are set in Railway
- Check Railway logs for "Failed to upload report to Supabase" errors
- Verify the `reports` bucket exists in Supabase Storage

### "Report" button does not appear after analysis

- The `report_storage_path` may not have been saved. Check the `insurance_policies` table in Supabase for the `report_storage_path` column.
- If `report_storage_path` is null but `analysis_status` is `completed`, the report upload to Supabase Storage failed. Check Railway logs.

### DB Webhook not firing

- Go to Supabase → Database → Webhooks and verify the webhook is active
- The webhook only fires on `INSERT` into `insurance_policies`. Updating an existing policy will not trigger it.
- Check the webhook URL matches your production URL exactly
- Check the Authorization header contains `Bearer ` followed by the service role key

### Cross-origin errors in browser console

- Update `CORS_ORIGINS` in Railway to include your exact production URL (with `https://`, no trailing slash)
- Redeploy Railway after changing the variable

---

## Cost Estimates

| Service | Free Tier | Paid Tier | Notes |
|---------|-----------|-----------|-------|
| Supabase | 500MB DB, 1GB storage, 50K auth users | $25/mo Pro | Free tier is sufficient to start |
| Vercel | 100GB bandwidth, serverless functions | $20/mo Pro | Free tier works for low traffic |
| Railway | $5 free credits/month | ~$5-10/mo | Pay per usage, idles cheaply |
| **Claude API** | — | **~$0.16-0.50 per analysis** | Haiku extraction + Sonnet scoring |

The Claude API cost dominates. Each policy analysis uses:
- Haiku 4.5 (extraction): ~$0.01-0.05
- Sonnet 4 (scoring): ~$0.15-0.45
- **Total per analysis: ~$0.16-0.50** depending on policy length

---

## Post-Deploy Checklist

- [ ] Code pushed to GitHub
- [ ] Supabase project created
- [ ] All three migrations run successfully
- [ ] `insurance-policies` bucket created (private)
- [ ] `reports` bucket created (private)
- [ ] Email auth enabled with correct redirect URLs
- [ ] Railway deployed and health check passes
- [ ] Railway `anthropic_configured` and `supabase_configured` both `true`
- [ ] Vercel deployed and login page loads
- [ ] `WEBHOOK_SECRET` is identical in Railway and Vercel
- [ ] `PRODUCTION_URL` in Vercel is the stable production URL (not a preview URL)
- [ ] `CORS_ORIGINS` in Railway matches the Vercel production URL
- [ ] Supabase DB Webhook created for `insurance_policies` INSERT
- [ ] Tenant and admin user seeded in database
- [ ] End-to-end test: upload PDF → analysis completes → score shows → report downloads
- [ ] Browser-close test: analysis completes even after closing browser
